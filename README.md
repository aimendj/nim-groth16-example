# Nim Groth16 Example

Example of using [nim-groth16](https://github.com/durability-labs/nim-groth16) to generate and verify Groth16 proofs on BN254.

**Groth16** is a zk-SNARK proof system that allows you to:
- **Prove**: Generate a proof that you know private inputs satisfying a circuit's constraints
- **Verify**: Check that a proof is valid using the Groth16 verification algorithm (pairing-based check)

## Two Approaches

This repository demonstrates two ways to use Groth16:

### 1. Programmatic (pure Nim)
- Creates circuits, witnesses, and trusted setup entirely in Nim
- No external tools required
- Takes `a` and `b` values as command-line inputs
- Useful for learning, testing, and dynamic circuit creation
- See: `src/inline_prove.nim`

### 2. File-based (using circom/snarkjs)
- Uses external tools (`circom`, `snarkjs`) to generate circuit files
- Requires `.zkey` and `.wtns` files
- Suitable for production workflows with existing circom circuits
- See: `src/file_prove.nim`

## Setup

```bash
make setup
```

This pulls all submodules including nim-groth16 and its dependencies (nim-taskpools and constantine with the correct branch).

**Note**: For the file-based approach, you also need `circom` and `snarkjs` installed:
```bash
npm install -g circom snarkjs
```

## Approach 1: Programmatic Example

### Running

Provide `a` and `b` values as arguments (must satisfy `a * b = 15`):

```bash
make run-inline-prove A=3 B=5
```

Or run directly:

```bash
./src/inline_prove 3 5
```

By default, this uses a fake trusted setup (for testing/development). To use a real zkey file from circom/snarkjs:

```bash
make run-inline-prove A=3 B=5 ZKEY=circuits/circuit.zkey
```

See [Getting Circuit Files](#getting-circuit-files) below for instructions on how to generate the zkey file.

Or run directly:

```bash
./src/inline_prove 3 5 circuits/circuit.zkey
```

This builds and runs `src/inline_prove.nim` which creates the circuit and witness programmatically. The trusted setup can be either fake (default) or from a real zkey file.

This example demonstrates how to:
1. **Create an R1CS circuit programmatically** - defines constraints directly in Nim without circom
2. **Create a witness programmatically** - constructs witness values from command-line inputs
3. **Perform a fake trusted setup** - generates the proving key (`zkey`) programmatically (for testing/development)
4. **Generate and verify a proof** - same proving/verification process as the file-based example

This is useful for:
- Understanding how circuits are structured internally
- Testing without needing circom/snarkjs
- Creating circuits dynamically in code
- Learning the R1CS constraint format

**Note**: The "fake" trusted setup uses random values instead of a real ceremony. For production use, you should use a proper trusted setup ceremony.

## Approach 2: File-based Example

### Running

You need a `.zkey` and `.wtns` file from a circom circuit:

```bash
make run-file-prove ZKEY=circuit.zkey WTNS=witness.wtns
```

Or run directly:

```bash
./src/file_prove circuit.zkey witness.wtns
```

This builds and runs `src/file_prove.nim` which requires `.zkey` and `.wtns` files generated by circom/snarkjs.

The example:
1. Loads the **zkey** (proving key) and **witness** files
2. **Generates a Groth16 proof** using `generateProof(zkey, witness)`
3. **Extracts the verification key** from the zkey using `extractVKey(zkey)`
4. **Verifies the proof** using `verifyProof(vkey, proof)`

**Important**: 
- **Proving** requires: zkey (proving key) + witness (private inputs)
- **Verifying** requires: vkey (verification key) + proof (no witness needed!)

The verification uses elliptic curve pairings to check that the proof satisfies the mathematical relationship without needing access to the private inputs (witness).

### Getting Circuit Files

You need `.zkey` (proving key) and `.wtns` (witness) files to run the file-based example.

**Prerequisites**: `circom` and `snarkjs` must be installed (see Setup section above).

#### Quick Start

Generate all circuit files at once:
```bash
make circuit-all
```

This will:
1. Create an example `circuit.circom` file
2. Compile it to `.r1cs` and `.wasm`
3. Generate powers-of-tau file
4. Create the `.zkey` file
5. Generate the `.wtns` file with default inputs

Then run:
```bash
make run-file-prove ZKEY=circuits/circuit.zkey WTNS=circuits/circuit.wtns
```

#### Step by Step

**Step 1: Create circuit file**
```bash
make circuit-init
```
Creates `circuits/circuit.circom` with an example Multiplier circuit. The circuit multiplies two private inputs `a` and `b` and constrains the output to equal 15 (a public value). The proof demonstrates that you know factors `a` and `b` such that `a * b = 15`, without revealing what those factors are.

```circom
template Multiplier() {
    signal input a;
    signal input b;
    signal output c;
    c <== a * b;
    c === 15;
}

component main = Multiplier();
```

**Step 2: Compile circuit**
```bash
make circuit-compile
```
Compiles the `.circom` circuit file into:
- `circuit.r1cs` - Rank-1 Constraint System file
- `circuit.wasm` - WebAssembly file for witness calculation

**Step 3: Generate powers-of-tau**
```bash
make circuit-pot
```
Generates a powers-of-tau file (`pot.ptau`) for the trusted setup ceremony. This will prompt you for random input during the contribution steps.

Or with custom size (default is 12 for 2^12 = 4096 constraints):
```bash
make circuit-pot POT_SIZE=14
```

**Step 4: Generate .zkey file**
```bash
make circuit-zkey
```
Creates the proving key (`.zkey` file) through the circuit-specific trusted setup. This will also prompt you for random input during the contribution steps.

Requires `circuit.r1cs` and `pot.ptau` from previous steps.

**Step 5: Generate .wtns file**
```bash
make circuit-wtns
```
Calculates the witness file (`.wtns`) which contains all values that satisfy your circuit's constraints for a given input.

Uses default input `{"a": 3, "b": 5}`. For custom input:
```bash
make circuit-wtns INPUT=myinput.json
```

**Custom Circuit Name**

Use a different circuit name:
```bash
make circuit-all CIRCUIT_NAME=mycircuit
```

## Files

- `src/inline_prove.nim` - Programmatic example (takes a and b as inputs, no external files needed)
- `src/file_prove.nim` - File-based example (uses circom/snarkjs files)
- `nim-groth16/` - The groth16 library (submodule)
- `deps/nim-taskpools/` - Task pools library (submodule)
- `deps/constantine/` - Cryptographic library (submodule, branch: v0.2.0-fix-nimble-windows)

## Links

- [nim-groth16](https://github.com/durability-labs/nim-groth16)
- [circom](https://github.com/iden3/circom)
- [snarkjs](https://github.com/iden3/snarkjs)
